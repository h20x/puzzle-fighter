<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Puzzle Fighter</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div id="field"></div>
      <textarea id="commands" class="commands"></textarea>
      <div class="controls">
        <button type="button" class="btn" id="prev-state">&lt;</button>
        <button type="button" class="btn" id="next-state">&gt;</button>
      </div>
      <div class="controls">
        <button type="button" class="btn" id="reset">&circlearrowleft;</button>
        <button type="button" class="btn" id="next-cmd">&gt;</button>
      </div>
    </div>

    <script type="module">
      import { Game } from './game.js';
      import { Field } from './field.js';

      const cols = 6;
      const rows = 12;

      const commands = restoreCommands();
      let cp = 0;

      let history = [];
      let hp = 0;

      const btnPrevState = document.getElementById('prev-state');
      const btnNextState = document.getElementById('next-state');
      const btnNextCmd = document.getElementById('next-cmd');
      const btnReset = document.getElementById('reset');
      const commandList = document.getElementById('commands');

      btnPrevState.addEventListener('click', prevState);
      btnNextState.addEventListener('click', nextState);
      btnNextCmd.addEventListener('click', nextCmd);
      btnReset.addEventListener('click', reset);

      document.addEventListener('keydown', (e) => {
        if (e.target === commandList) {
          return;
        }

        switch (e.code) {
          case 'ArrowLeft':
          case 'ArrowUp':
          case 'KeyQ':
            return prevState();

          case 'ArrowRight':
          case 'ArrowDown':
          case 'KeyW':
            return nextState();

          case 'KeyE':
            return nextCmd();

          case 'KeyR':
            return reset();
        }
      });

      let game = new Game(cols, rows);
      const field = new Field(cols, rows, document.getElementById('field'));

      field.render();
      nextCmd();

      function reset() {
        cp = hp = 0;
        history = [];
        game = new Game(cols, rows);
        parseCommands();
        saveCommands();
        nextCmd();
      }

      function nextCmd() {
        if (cp >= commands.length) {
          hp = history.length - 1;
        } else {
          hp = 0;
          history = game.exec(commands[cp++]);
        }

        if (history.length) {
          field.render(history[hp]);
        }

        updateCommandList();
        updateControls();
      }

      function updateControls() {
        btnPrevState.disabled = hp <= 0;
        btnNextState.disabled = hp >= history.length - 1;
        btnNextCmd.disabled = cp >= commands.length;
      }

      function updateCommandList() {
        commandList.value = commands.reduce((acc, cur, i) => {
          return acc + (i === cp - 1 ? '> ' : '  ') + cur.join(', ') + '\n';
        }, '');
      }

      function parseCommands() {
        commands.length = 0;
        commandList.value
          .trim()
          .split('\n')
          .filter(Boolean)
          .forEach((str) => {
            str = str.replace(/(\s|>)/g, '');
            const c = str.split(',');
            c[1] = c[1].toUpperCase();
            commands.push(c);
          });
      }

      function saveCommands() {
        localStorage.setItem('commands', JSON.stringify(commands));
      }

      function restoreCommands() {
        const commands = localStorage.getItem('commands');

        return commands ? JSON.parse(commands) : [];
      }

      function nextState() {
        if (hp >= history.length - 1) {
          return;
        }

        hp = Math.min(++hp, history.length - 1);
        field.render(history[hp]);
        updateControls();
      }

      function prevState() {
        if (hp <= 0) {
          return;
        }

        hp = Math.max(--hp, 0);
        field.render(history[hp]);
        updateControls();
      }
    </script>
  </body>
</html>
